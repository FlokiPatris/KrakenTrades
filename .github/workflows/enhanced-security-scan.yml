# üîê AppSec ‚Äî Security, Secrets & Shell Script Scan (DRY, Makefile-driven)
# - Single source of truth: defers to Makefile targets for all scans
# - CI-only responsibilities: SARIF upload, gating, artifact hardening
# - No magic constants: all tunables centralized in env
# - Public repo safe: minimal permissions, no secrets echoed, hardened artifacts

name: "üîê AppSec ‚Äî Security, Secrets & Shell Script Scan"

# ------------------------
# Workflow triggers
# ------------------------
on:
  pull_request:
    branches: ["**"]
    paths:
      - "**.sh"
      - ".ci/bin/**"
      - "Makefile"
  workflow_dispatch:     # Manual trigger option

# ------------------------
# Permissions
# ------------------------
permissions:
  contents: read           # Only read repo contents
  security-events: write   # Needed for SARIF uploads & security events

# ------------------------
# Concurrency
# ------------------------
concurrency:
  group: appsec-scan-${{ github.ref }}  # One run per branch
  cancel-in-progress: true              # Cancel old runs if new one triggers

# ------------------------
# Environment variables
# ------------------------
env:
  PYTHON_VERSION: "3.11"        # Python runtime
  SARIF_DIR: "sarif-reports"    # Output folder for SARIF
  # Only upload SARIF on push or same-repo PRs (forks are excluded)
  UPLOAD_SARIF: ${{ github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository) }}

# ------------------------
# Jobs
# ------------------------
jobs:
  security:
    name: Run Makefile AppSec suite
    runs-on: ubuntu-latest
    timeout-minutes: 20
    defaults:
      run:
        shell: bash

    steps:
      - name: üì• Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: üì¶ Install Python dependencies
        run: make install-deps

      - name: üß∞ Install minimal system dependencies
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            make ca-certificates git curl jq
          sudo rm -rf /var/lib/apt/lists/*

      - name: üîê Run AppSec suite via Makefile
        run: make appsec  # Delegates scanning to Makefile (DRY)

      - name: üßπ Harden SARIF artifacts (permissions)
        if: always()
        env:
          SARIF_DIR: ${{ env.SARIF_DIR }}
          UPLOAD_SARIF: ${{ env.UPLOAD_SARIF }}
        run: |
          set -euo pipefail
          if [[ -d "${SARIF_DIR}" ]]; then
            # Restrict file permissions to owner only
            find "${SARIF_DIR}" -type f -name "*.sarif" -exec chmod 600 {} \; || true
            find "${SARIF_DIR}" -type d -exec chmod 700 {} \; || true
          fi
          echo "Audit: SARIF permissions set, uploads gated by UPLOAD_SARIF=${UPLOAD_SARIF}."

      - name: üì¶ Upload SARIF bundle (for post-processing)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sarif-bundle
          path: ${{ env.SARIF_DIR }}/*.sarif
          if-no-files-found: ignore
          retention-days: 2

  sarif-upload:
    name: Upload SARIF to Security tab
    needs: [security]  # Wait for security job
    runs-on: ubuntu-latest
    # Only run for push or same-repo PR
    if: ${{ needs.security.result != 'cancelled' && (github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository)) }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - file: trivy.sarif
            category: sec-trivy
          - file: gitleaks.sarif
            category: secrets-gitleaks
          - file: pip-audit.sarif
            category: deps-pip-audit
          - file: shellcheck.sarif
            category: lint-shellcheck
          - file: bandit.sarif
            category: code-bandit
    env:
      SARIF_DIR: "sarif-reports"

    steps:
      - name: üì• Download SARIF bundle
        uses: actions/download-artifact@v4
        with:
          name: sarif-bundle
          path: ${{ env.SARIF_DIR }}

      - name: ‚¨ÜÔ∏è Upload ${{ matrix.category }} SARIF
        # Only upload if the SARIF file exists (avoids errors)
        if: ${{ always() && hashFiles(format('{0}/{1}', env.SARIF_DIR, matrix.file)) != '' }}
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ env.SARIF_DIR }}/${{ matrix.file }}
          category: ${{ matrix.category }}
          wait-for-processing: true
